// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["public"]
}

// This model maps to the existing auth.users table in Supabase
model User {
  @@schema("public")
  @@map("users")
  
  id            String            @id @db.Uuid
  email         String?           @db.VarChar(255)
  role          String?           @db.VarChar(255) @default("USER")
  created_at    DateTime?         @db.Timestamptz(6)
  updated_at    DateTime?         @db.Timestamptz(6)
  
  // Relations
  categories   HistoryCategory[]
  histories    History[]
  followers    UserFollower[]     @relation("followers")
  following    UserFollower[]     @relation("following")
}

enum HistoryType {
  INCOME
  SPEND

  @@schema("public")
}

model Banner {
  @@schema("public")
  @@map("banners")

  id         BigInt      @id @default(autoincrement())
  name       String
  url        String
  created_at DateTime    @default(now())
  updated_at DateTime    @updatedAt
  deleted_at DateTime?
}

model HistoryCategory {
  @@schema("public")
  @@map("history_categories")
  
  id         BigInt      @id @default(autoincrement())
  name       String
  created_at DateTime    @default(now())
  updated_at DateTime    @updatedAt
  deleted_at DateTime?
  user_id    String?     @db.Uuid
  user       User?       @relation(fields: [user_id], references: [id])
  histories  History[]
}

model History {
  @@schema("public")
  @@map("histories")
  
  id          BigInt      @id @default(autoincrement())
  name        String
  category_id BigInt
  category    HistoryCategory @relation(fields: [category_id], references: [id], onDelete: Restrict)
  image_url   String?
  type        HistoryType
  ts_at       DateTime    @default(now())
  amount      Float       @default(0)
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt
  deleted_at  DateTime?
  user_id     String?     @db.Uuid
  user        User?       @relation(fields: [user_id], references: [id])
}

model UserFollower {
  @@schema("public")
  @@map("user_followers")
  
  from_id    String   @db.Uuid
  with_id    String   @db.Uuid
  created_at DateTime @default(now())
  from       User     @relation("following", fields: [from_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  with       User     @relation("followers", fields: [with_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([from_id, with_id])
  @@index([created_at(sort: Desc)])
}
